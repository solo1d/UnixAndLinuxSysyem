# UnixAndLinuxSysyem
- [UNIX文件系统特点](#UNIX文件系统特点)
- [构建原语](#构建原语)
- [操作系统服务](#操作系统服务)
- [中断与例外](#中断与例外)
- [UNIX操作系统的体系结构](#UNIX操作系统的体系结构)
- [文件子系统概貌](#文件子系统概貌)
    - [文件系统结构](#文件系统结构)
-  [进程](#进程)
-  


**Unix和Linux操作系统设计**
***笔记书籍为 Unix操作系域设计  和  Linux内核设计与实现(原书第三版)***

***一旦掌握算法的基本思想，会对源代码的阅读和理解就会容易很多.***
**从逻辑上讲设备是文件系统的一部分,但是,进程控制的问题要在终端驱动程序中出现.**


- Unix 系统可分为两部分：
    - 第一部分由一些程序和服务组成， 其中包括Shell程序，邮件程序，正文处理程序包 以及源代码控制系统等
        - 它们是用户立即可见的部分
    - 第二部分由支持这些程序和服务的操作系统组成. 


```c
操作系统直接与硬件交互, 向程序提供公共服务,并使它们同硬件隔离.
系统调用的集合及实现系统调用的内部算法形成了内核的主体.
内核提供了UNIX系统全部应用程序所依赖的服务,也定义了这些服务.
```
 
## UNIX文件系统特点
- 层次结构
- 对文件数据的一致的处理
- 建立与删除文件的能力
- 文件的动态增长
- 文件数据的保护
- 把外围设备(如终端及磁带装置) 作为文件对待

**文件名是由路径名给出的, 路径名描述了怎样在一个文件系统树中确定一个文件的位置，  文件名是一个分量名序列,各分量名之间用斜杠符隔开.**

```c
在UNIX系统中,程序不了解核心按怎样的内部格式存储文件,而把数据作为无格式的字节流看待,
    程序可以按照它们自己的意愿去解释字节流, 但这种解释与操作系统如何存储数据无关.
    对文件中数据进行存取的语法是由系统定义的,并且对所有的程序都是同样的.
```


## 构建原语
**Unix系统的宗旨是童工操作系统原语，使用户能编写小的,模块化的程序,并把它们作为构建(building block) 去构建更复杂的程序.**



- 属于原语的能力
    - 重定向I/O   `bash$  cat < file > out  2>/dev/null`
    - 管道  进程间传递数据流的机制.  避免了临时文件的需求.  `bash$  cat a.c | grep 'include' | wc -l`
    
## 操作系统服务
**内核代表用户进程完成各种原语操作,以便支持用户使用的接口.**
- 内核提供的服务有:
    - 通过允许进程创建, 终止, 挂起 及通信来控制进程的执行
    - 对进程在 CPU 上的执行进行公平调度,
    - 对正在执行的进程分配主存, 对换系统, 请求调页系统.
    - 为实现用户数据的有效存储和检索而分配二级存储. 这一服务构成文件系统
    - 允许进程对诸如终端, 磁带机, 磁盘 以及网络设备等 进行有控制的存储.
- **内核提供的服务是透明的**
    -  内核能识别一个给定文件是正规文件还是一个设备,但内核向用户隐蔽了它们的区别

## 中断与例外
UNIX系统允许I/O外围设备或系统时钟异步地中断CPU.
- 中断处理过程：
    - 收到中断 
    - 内核保存它的上下文
    - 判定中断原因
    - 为中断服务
    - 内核恢复被中断了的上下文
    - 继续运行

**硬件通常按照中断被处理的次序给设备赋予优先权: 当内核为某个中断服务时, 它封锁较低优先级的中断, 但为更高优先级的中断服务** 

- 例外条件: 指的是由一个进程引起的非期望时间.
    - 包括： 非法存储寻址, 执行特权指令， 除数为0 等
    - 它们与来自进程外部的事件 所引起起的中断是有区别的
        - **例外事件发生在一条指令执行的过程中间， 并且系统试图在处理完例外事件之后重新执行 该指令**
        - **中断被认为使在两条指令的执行之间发生, 并且系统在对中断服务完毕之后, 从下一条指令继续执行**

| 高优先级  |
| --- |
| **机器错误** |
| **时钟**   |
| **磁盘**   |
| **网络设备**   |
| **终端**   |
| **软件中断**   |
| 低优先级   |



# UNIX操作系统的体系结构
-  **文件和进程这两类实体是 UNIX系统模型的两个中心概念**
    -  主要成分有 文件子系统 和 进程控制子系统

- 系统内核框架的三个层次： 用户级， 内核级， 硬件级
    -  系统调用与库接口体现了用户程序与内核间的边界
        -  库把这些函数调用映射成进入操作系统所需的原语
        -  汇编不可以不经过 系统调用库 尔直接引用系统调用
    - 库是用户程序的一部分

------
系统调用的集合分成与文件子系统交互的部分以及进程控制子系统交互的部分
`文件子系统管理文件, 其中包括分配文件空间, 管理空闲空间, 控制对文件的存取以及为用户检索数据. 操作有: open, close, read, write , stat , chmod ,chown`
    
------
**文件子系统使用一个缓冲机制存取文件数据, 缓冲机制调节在内核与二级存储设备之间的数据流.**
缓冲机制同块 I/O 设备驱动交互, 以便启动往内核去的数据传送及从内核来的数据传送
***设备驱动程序是用来控制外围设备操作的内核模块***

- 块I/O 设备是随机存取 存储设备
    - 它们的设备驱动程序使得它们对与系统的其他部分来说好像是随机存取 存储设备

***文件子系统还可以在没有缓冲机制干预的情况下直接与 原始I/O 设备驱动程序交互. `(原始设备， 有时北被称为字符设备， 包括所有不是块设备的设备)`***
    
------
进程控制子系统负责进程同步， 进程间通信， 存储管理 及进程调度.
文件子系统与进程控制子系统交互， 进程子系统在执行可执行文件之前，把它们读到主存中.
**`fork , exec, exit, brk控制分配给一个进程的存储空间的大小, signal进程控制对特别事件的响应`**

**进程间通信有几种形式， 从事件的异步软中断信号到进程间消息的同步传输 等等**

------
存储管理模块控制存储分配. 内存交换分区， 对换和请求调页
调度程序(scheduler)模块把CPU 分配给进程.

------
硬件控制负责处理中断及与机器通信.
**中断不是由特殊的进程服务的, 而是由内核中的特殊函数服务的, 这些特殊函数是在当前运行的进程的上下文中被调用**

## 文件子系统概貌
**一个文件的内部表示由一个索引节点(inode) 给出， 索引节点描述了文件数据在磁盘上的布局,并且包含诸如文件所有者,存储许可权及存取时间等 其他信息**

每个文件都有一个索引节点,但是它可以有几个名字，且这几个名字都映射到该索引节点上,每个名字都被称为一个联结(link)

`当进程使用名字访问一个文件时, 内核每次分析文件名中的一个分量, 检查该进程是否有权搜索路径中的目录, 并且最终检索到文件所对应的索引节点`





- 内核还包含另外两个数据结构： 文件表 和 用户描述符表(user file descriptor table)
    - 文件表 是一个全局核心结构, 但用户文件描述符表对每个进程分配一个表.
        - 当一个进程打开或建立一个文件时, 内核在每个表中为相应于该文件的索引节点分配一个表项

- **有三种结构表: `用户文件描述符表, 文件表, 索引节点表(inode table)`  , 用这三种结构表中的表相来维护文件的状态及用户对它的存取**
    - 文件表 保存着文件中的字节偏移量， 下一次读或写将从哪里开始，并保存着对打开的进程所允许的存取权限
    - 用户文件描述符表 标识着一个进程的所有打开文件
    - **索引节点被存储在文件系统中, 但是当操控文件时,内核把它们读到内存(in-core) 索引节点表中**
        - 当一个进程建立一个新文件时, 内核分配给它一个尚未使用的索引节点.

```c
  三张表的关系：
    对于系统调用 open 和系统调用 creat， 内核返回一个文件描述符,它是在用户文件描述符表中的索引值.
    当执行系统调用 read 和 write 时, 内核使用文件描述符以存取用户文件描述符表,
    循着指向文件表及索引节点表 表项的指针, 从索引节点中找到文件中的数据。
只要使用这三张表可以实现对一个文件的不同程度的存取共享就够了
```

- **UNIX 系统把正规文件(regual file) 及目录保存在诸如磁带或磁盘这样的块设备上**
    - 内核在逻辑级上只涉及文件系统，而不涉及磁盘, 把每个文件系统都当作一个逻辑设备号标识的逻辑设备 (logical device).
        - **由磁盘驱动程序实现逻辑设备(文件系统) 地址于物理设备(磁盘) 地址之间的转换**

------
**一个文件系统由一个逻辑块序列组成， 每个块都包含 512,1024,4096字节 或 512个字节的任意倍数, 这要依赖于系统实现.**

```c
在一个文件系统中,逻辑块大小是完全相同的, 但是在一个系统配置中的 不同文件系统间逻辑块大小可以时不同的.
```


### 文件系统结构
|  引导块  |  超级块  |  索引节点表  |  数据块  |
| --- | --- | --- | --- |
- 引导块: 占据文件系统的开头,典型地 是一个扇区.
    - 它可以含有被读入机器中起引导或初启动操作系统作用的引导代码. (每个文件系统都有一个引导块)
- 超级块: 描述了文件系统的状态, 多大, 能存储多少文件, 在文件系统的何处可找到空闲空间, 以及其他信息
- 索引节点表: 是一张装有索引节点的表, 它在文件系统中跟在超级块后面.
    - 当配置一个文件系统时,管理人员应指明索引节点表的大小
    - 内核通过索引来访问索引节点表中的索引节点
    - 有一个索引节点是文件系统的根索引节点(root inode): 在执行 mount 之后, 该文件系统的目录结构就可以从这个根索引节点开始进程存取了
- 数据块 在索引节点表结束后开始, 并且包含文件数据与管理数据. 一个已被分配的数据块, 能且仅能属于文件系统的一个文件 (4096)


### 进程
0进程时特殊进程,它是在系统引导时被 手工 创建的, 当它创建了一个子进程 (1进程) 之后, 0进程就变成了对换进程.
1进程被称为 init 进程,它是系统中其他每个进程的主线, 并且享有它们之间的特殊关系
- 一个被编译的可执行文件, 由以下几个部分组成:
    - 描述文件 属性的一组 头标(header)
    - 程序正文
    - 数据的机器语言表示, 它给出程序开始执行时的初值, 一个空间指示, 它指出内核应该为 被称为 bss 的未初始化数据分配多大的空间( 在运行时 内核把bss 的初值置为0 )
    - 其他段, 诸如符号表信息

------
- 在系统调用exec 期间, 内核把一个可执行文件装入主存中, 被装入的进程至少由被称为 正文区, 数据区 及 栈区 三部分组成.
    - 正文区和数据区应相应于可执行文件中的正文段和数据 bss 段
    - 栈区是自动创建的, 而且大小是在运行时被内核动态调节的
            - 用户栈和核心栈(内核)是分开的, 当进程在用户态下执行时, 它的核心栈是空的

------
```c
每个进程在内核进程表(process table) 中都有一个表项, 并且每个进程都被分配一个ublock(u区), u区包含仅被内核操纵的私有数据
   进程表包含(或指向) 一个本进程区表 (per process region table), 本进程区表的表项指向区表(region table) 的表项. 进程的控制信息和状态信息, u区是进程表 表项的拓展.
       一个区是进程地址空间中连续的区域, 如正文区,数据区,栈区 等.
       区表登记描述符区的属性, 诸如他是否包含正文或数据,它是共享的还是私用的,以及区的数据位于主存的何处 等等.
       从本进程区表到区表的额外伺接级允许彼此独立的进程对区的共享.
           当一个进程调用系统调用exec时,在释放了进程一直在使用着老区之后,内核视它为正文,数据和栈分配新区.
           当一个进程调用系统调用fork时,内核拷贝老进程的地址空间, 在可能时允许进程对区共享,否则再建立一个物理拷贝.
           当一个进程调用系统调用exit时,内核释放进程使用过的区.

    u区包含用来描述进程的信息,这些信息仅当进程正在执行时才是可存取的, u区是进程表 表项的拓展.
          * 字段如下
            - 指向单曲正在执行的进程的进程表项的指针
            - 当前系统调用的参数, 返回值及错误码
            - 所有的打开文件的描述符
            - 内部I/O参数
            - 当前目录(curret directory) 和当前根(curret root)
            - 进程及文件大小的限制
    进程表的主要字段如下:
         - 状态字段
         - 标识符 ,拥有该进程的用户( 用户ID或UID)
         - 当一个进程被挂起 (sleep状态) 时的事件描述符集合

*内核能直接存取正在执行的进程的u区的字段, 但不能存取其他进程的u区的字段.
```
------
- **进程上下文**
    - 一个进程的上下文包括 被进程正文所定义的 进程状态,进程的全局用户变量和数据结构的值, 它使用机器寄存器的值, 存储在它的进程表项与u区中的值以及他的用户栈和核心栈的内容.
        - **操作系统的正文和它的全局数据结构被所有的进程所共享, 因而不是进程上下文的一部分**










